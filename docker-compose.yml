version: '3.8'

services:
  app:
    # [修正1] 明确指定改名后的 Dockerfile，避开 Zeabur 的自动检测冲突
    build:
      context: .
      dockerfile: Dockerfile
    container_name: neuromemory_app
    volumes:
      - .:/app
    environment:
      # --- 1. 注入 Zeabur 的密钥 ---
      - DeepSeekApiKey
      - SiliconFlowApiKey
      
      # --- 2. 统一密码逻辑 (关键修正) ---
      # 让 App 读取 Zeabur 里的 NEO4J_PASSWORD，如果没有则用 password123
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password123}
      
      # --- 3. 架构连接 ---
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6400
      
      # 业务开关
      - ENABLE_GRAPH_STORE=true

    depends_on:
      - neo4j
      - qdrant
    ports:
      - "8765:8765"

  neo4j:
    image: neo4j:5.26.0
    container_name: memory_graph_db
    ports:
      - "17687:7687" 
      - "7474:7474"
    environment:
      # [修正2] 这里的密码也不能写死！必须引用同一个变量
      # 这样 Zeabur 上是 zeabur2025，本地是 password123，完全同步
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-password123}
      
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
    volumes:
      - neo4j_data:/data
    # 健康检查建议加上，防止 App 启动太快连不上
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p ${NEO4J_PASSWORD:-password123} 'RETURN 1'"]
      interval: 10s
      timeout: 5s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    container_name: memory_vector_db
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6400
    ports:
      - "6400:6400"
    volumes:
      - qdrant_data:/qdrant/storage

volumes:
  neo4j_data:
  qdrant_data: