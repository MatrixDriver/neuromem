# å¯è§‚æµ‹æ€§è®¾è®¡

> è¿”å› [ä¸»æ¶æ„æ–‡æ¡£](ARCHITECTURE.md)

**çŠ¶æ€**: ğŸ“‹ è§„åˆ’

---

## ç›®å½•

- [è§‚æµ‹ä¸‰æ”¯æŸ±](#è§‚æµ‹ä¸‰æ”¯æŸ±)
- [å…³é”®æŒ‡æ ‡ (Metrics)](#å…³é”®æŒ‡æ ‡-metrics)
- [åˆ†å¸ƒå¼è¿½è¸ª (Tracing)](#åˆ†å¸ƒå¼è¿½è¸ª-tracing)
- [ç»“æ„åŒ–æ—¥å¿— (Logging)](#ç»“æ„åŒ–æ—¥å¿—-logging)

---

## è§‚æµ‹ä¸‰æ”¯æŸ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¯è§‚æµ‹æ€§æ¶æ„ [ğŸ“‹ è§„åˆ’]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Metrics      â”‚  â”‚    Tracing      â”‚  â”‚    Logging      â”‚ â”‚
â”‚  â”‚  (Prometheus)   â”‚  â”‚    (Jaeger)     â”‚  â”‚  (Loki/ELK)     â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚  â€¢ è¯·æ±‚å»¶è¿Ÿ     â”‚  â”‚  â€¢ è¯·æ±‚é“¾è·¯    â”‚  â”‚  â€¢ ç»“æ„åŒ–æ—¥å¿—   â”‚ â”‚
â”‚  â”‚  â€¢ ååé‡       â”‚  â”‚  â€¢ è·¨æœåŠ¡è¿½è¸ª  â”‚  â”‚  â€¢ é”™è¯¯å †æ ˆ     â”‚ â”‚
â”‚  â”‚  â€¢ é”™è¯¯ç‡       â”‚  â”‚  â€¢ æ€§èƒ½ç“¶é¢ˆ    â”‚  â”‚  â€¢ å®¡è®¡æ—¥å¿—     â”‚ â”‚
â”‚  â”‚  â€¢ èµ„æºä½¿ç”¨     â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                    â”‚                    â”‚          â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                â–¼                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                    â”‚      Grafana        â”‚                     â”‚
â”‚                    â”‚   ç»Ÿä¸€å¯è§†åŒ–é¢æ¿     â”‚                     â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®æŒ‡æ ‡ (Metrics)

### ä¸šåŠ¡æŒ‡æ ‡

```yaml
neuromemory_memory_add_total:
  type: counter
  description: è®°å¿†æ·»åŠ æ€»æ•°
  labels: [user_id, status]

neuromemory_search_duration_seconds:
  type: histogram
  description: æ£€ç´¢å»¶è¿Ÿåˆ†å¸ƒ
  labels: [user_id, source_type]  # source_type: vector/graph/hybrid

neuromemory_reasoning_duration_seconds:
  type: histogram
  description: LLM æ¨ç†å»¶è¿Ÿ
  labels: [model, user_id]
```

### ç³»ç»ŸæŒ‡æ ‡

```yaml
neuromemory_neo4j_nodes_total:
  type: gauge
  description: Neo4j èŠ‚ç‚¹æ€»æ•°

neuromemory_qdrant_vectors_total:
  type: gauge
  description: Qdrant å‘é‡æ€»æ•°

neuromemory_llm_tokens_total:
  type: counter
  description: LLM Token æ¶ˆè€—
  labels: [model, direction]  # direction: input/output
```

### æŒ‡æ ‡æ±‡æ€»

| æŒ‡æ ‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `memory_add_total` | Counter | è®°å¿†æ·»åŠ è®¡æ•° |
| `search_duration_seconds` | Histogram | æ£€ç´¢å»¶è¿Ÿ |
| `reasoning_duration_seconds` | Histogram | æ¨ç†å»¶è¿Ÿ |
| `neo4j_nodes_total` | Gauge | å›¾è°±èŠ‚ç‚¹æ•° |
| `qdrant_vectors_total` | Gauge | å‘é‡æ•°é‡ |
| `llm_tokens_total` | Counter | Token æ¶ˆè€— |

---

## åˆ†å¸ƒå¼è¿½è¸ª (Tracing)

### è¿½è¸ªé“¾è·¯ç¤ºä¾‹

ä¸€æ¬¡ `cognitive_process` è°ƒç”¨çš„è¿½è¸ªé“¾è·¯:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Trace: cognitive_process                                       â”‚
â”‚  TraceID: abc123                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  [Span] cognitive_process (parent)                              â”‚
â”‚  â”œâ”€â”€ [Span] hybrid_retrieval                                    â”‚
â”‚  â”‚   â”œâ”€â”€ [Span] qdrant_search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 50ms            â”‚
â”‚  â”‚   â””â”€â”€ [Span] neo4j_traverse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 80ms            â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€â”€ [Span] llm_reasoning                                       â”‚
â”‚  â”‚   â””â”€â”€ [Span] deepseek_invoke â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1200ms          â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€â”€ [Span] memory_consolidation                                â”‚
â”‚      â”œâ”€â”€ [Span] entity_extraction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 800ms           â”‚
â”‚      â”œâ”€â”€ [Span] qdrant_upsert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 30ms            â”‚
â”‚      â””â”€â”€ [Span] neo4j_merge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 60ms            â”‚
â”‚                                                                 â”‚
â”‚  Total: 2220ms                                                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Span å®šä¹‰

| Span åç§° | çˆ¶ Span | è¯´æ˜ |
|-----------|---------|------|
| `cognitive_process` | - | é¡¶å±‚ Span |
| `hybrid_retrieval` | cognitive_process | æ··åˆæ£€ç´¢ |
| `qdrant_search` | hybrid_retrieval | å‘é‡æœç´¢ |
| `neo4j_traverse` | hybrid_retrieval | å›¾è°±éå† |
| `llm_reasoning` | cognitive_process | LLM æ¨ç† |
| `memory_consolidation` | cognitive_process | è®°å¿†æ•´åˆ |
| `entity_extraction` | memory_consolidation | å®ä½“æå– |

---

## ç»“æ„åŒ–æ—¥å¿— (Logging)

### æ—¥å¿—æ ¼å¼

```json
{
  "timestamp": "2025-01-12T10:30:00.123Z",
  "level": "INFO",
  "service": "neuromemory",
  "trace_id": "abc123",
  "span_id": "def456",
  "user_id": "user_001",
  "event": "cognitive_process_completed",
  "duration_ms": 2220,
  "details": {
    "input_length": 50,
    "retrieval_results": 5,
    "retrieval_sources": {"vector": 3, "graph": 2},
    "output_length": 200,
    "model": "deepseek-chat"
  }
}
```

### æ—¥å¿—å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `timestamp` | datetime | æ—¥å¿—æ—¶é—´ (ISO 8601) |
| `level` | string | æ—¥å¿—çº§åˆ« (DEBUG/INFO/WARN/ERROR) |
| `service` | string | æœåŠ¡åç§° |
| `trace_id` | string | è¿½è¸ª ID |
| `span_id` | string | Span ID |
| `user_id` | string | ç”¨æˆ·æ ‡è¯† |
| `event` | string | äº‹ä»¶åç§° |
| `duration_ms` | number | è€—æ—¶ (æ¯«ç§’) |
| `details` | object | è¯¦ç»†ä¿¡æ¯ |

### æ—¥å¿—çº§åˆ«è§„èŒƒ

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ |
|------|----------|
| DEBUG | è°ƒè¯•ä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒå…³é—­ |
| INFO | æ­£å¸¸æ“ä½œè®°å½• |
| WARN | å¯æ¢å¤çš„å¼‚å¸¸æƒ…å†µ |
| ERROR | éœ€è¦å…³æ³¨çš„é”™è¯¯ |

---

## ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æ¶æ„](DEPLOYMENT.md) - å¯è§‚æµ‹æ€§å¹³å°éƒ¨ç½²
- [é…ç½®å‚è€ƒ](CONFIGURATION.md) - æ—¥å¿—é…ç½®
